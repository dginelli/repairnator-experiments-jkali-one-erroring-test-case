<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchemaGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DigitalCollections: Blueprints 2 (Backend IMPL Jpa)</a> &gt; <a href="index.source.html" class="el_package">de.digitalcollections.blueprints.crud.backend.impl.database</a> &gt; <span class="el_source">SchemaGenerator.java</span></div><h1>SchemaGenerator.java</h1><pre class="source lang-java linenums">package de.digitalcollections.blueprints.crud.backend.impl.database;

import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import javax.persistence.Entity;
import org.hibernate.cfg.Configuration;
import org.hibernate.tool.hbm2ddl.SchemaExport;
import org.springframework.core.io.Resource;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;
import org.springframework.core.io.support.ResourcePatternResolver;
import org.springframework.core.type.classreading.CachingMetadataReaderFactory;
import org.springframework.core.type.classreading.MetadataReader;
import org.springframework.core.type.classreading.MetadataReaderFactory;
import org.springframework.util.ClassUtils;
import org.springframework.util.SystemPropertyUtils;

public class SchemaGenerator {

  private final Configuration cfg;

  /**
   * Example: java SchemaGenerator de.digitalcollections.blueprints.crud.backend.impl.jpa.entity src/main/resources/sql/generated/
   *
   * @param args first argument is the package to scan for entities, second argument directory to generate the dll to
   * @throws java.lang.Exception when writing to the database fails
   */
  public static void main(String[] args) throws Exception {
<span class="nc" id="L31">    final String packageName = args[0];</span>
<span class="nc" id="L32">    SchemaGenerator gen = new SchemaGenerator(packageName);</span>
<span class="nc" id="L33">    final String directory = args[1];</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">    if (directory != null) {</span>
<span class="nc" id="L35">      File dir = new File(directory);</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">      if (!dir.exists()) {</span>
<span class="nc" id="L37">        dir.mkdirs();</span>
      }
    }
<span class="nc" id="L40">    gen.generate(Dialect.POSTGRESQL, directory);</span>
<span class="nc" id="L41">    gen.generate(Dialect.MYSQL, directory);</span>
<span class="nc" id="L42">    gen.generate(Dialect.ORACLE, directory);</span>
<span class="nc" id="L43">    gen.generate(Dialect.HSQL, directory);</span>
<span class="nc" id="L44">    gen.generate(Dialect.H2, directory);</span>
<span class="nc" id="L45">  }</span>

<span class="nc" id="L47">  public SchemaGenerator(String packageName) throws Exception {</span>
<span class="nc" id="L48">    cfg = new Configuration();</span>
<span class="nc" id="L49">    cfg.setProperty(&quot;hibernate.hbm2ddl.auto&quot;, &quot;create&quot;);</span>

//        for (Class clazz : getClasses(packageName)) {
//            cfg.addAnnotatedClass(clazz);
//        }
<span class="nc" id="L54">    List&lt;Class&gt; entitiesInPackage = findAnnotatedClassesInPackage(packageName, Entity.class);</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">    for (Class clazz : entitiesInPackage) {</span>
<span class="nc" id="L56">      cfg.addAnnotatedClass(clazz);</span>
<span class="nc" id="L57">    }</span>
<span class="nc" id="L58">  }</span>

  /**
   * Utility method used to fetch Class list based on a package name.
   *
   * @param packageName (should be the package containing your annotated beans.
   */
  private List&lt;Class&gt; getClasses(String packageName) throws Exception {
<span class="nc" id="L66">    File directory = null;</span>
    try {
<span class="nc" id="L68">      ClassLoader cld = getClassLoader();</span>
<span class="nc" id="L69">      URL resource = getResource(packageName, cld);</span>
<span class="nc" id="L70">      directory = new File(resource.getFile());</span>
<span class="nc" id="L71">    } catch (NullPointerException ex) {</span>
<span class="nc" id="L72">      throw new ClassNotFoundException(packageName + &quot; (&quot; + directory</span>
              + &quot;) does not appear to be a valid package&quot;);
<span class="nc" id="L74">    }</span>
<span class="nc" id="L75">    return collectClasses(packageName, directory);</span>
  }

  private ClassLoader getClassLoader() throws ClassNotFoundException {
<span class="nc" id="L79">    ClassLoader cld = Thread.currentThread().getContextClassLoader();</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">    if (cld == null) {</span>
<span class="nc" id="L81">      throw new ClassNotFoundException(&quot;Can't get class loader.&quot;);</span>
    }
<span class="nc" id="L83">    return cld;</span>
  }

  private URL getResource(String packageName, ClassLoader cld) throws ClassNotFoundException {
<span class="nc" id="L87">    String path = packageName.replace('.', '/');</span>
<span class="nc" id="L88">    URL resource = cld.getResource(path);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">    if (resource == null) {</span>
<span class="nc" id="L90">      throw new ClassNotFoundException(&quot;No resource for &quot; + path);</span>
    }
<span class="nc" id="L92">    return resource;</span>
  }

  private List&lt;Class&gt; collectClasses(String packageName, File directory) throws ClassNotFoundException {
<span class="nc" id="L96">    List&lt;Class&gt; classes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">    if (directory.exists()) {</span>
<span class="nc" id="L98">      String[] files = directory.list();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">      for (String file : files) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (file.endsWith(&quot;.class&quot;)) {</span>
          // removes the .class extension
<span class="nc" id="L102">          classes.add(Class.forName(packageName + '.'</span>
<span class="nc" id="L103">                  + file.substring(0, file.length() - 6)));</span>
        }
      }
<span class="nc" id="L106">    } else {</span>
<span class="nc" id="L107">      throw new ClassNotFoundException(packageName</span>
              + &quot; is not a valid package&quot;);
    }
<span class="nc" id="L110">    return classes;</span>
  }

  /**
   * Method that actually creates the file.
   *
   * @param dialect to use
   */
  private void generate(Dialect dialect, String directory) {
<span class="nc" id="L119">    cfg.setProperty(&quot;hibernate.dialect&quot;, dialect.getDialectClass());</span>
<span class="nc" id="L120">    SchemaExport export = new SchemaExport(cfg);</span>
<span class="nc" id="L121">    export.setDelimiter(&quot;;&quot;);</span>
<span class="nc" id="L122">    export.setOutputFile(directory + &quot;ddl_&quot; + dialect.name().toLowerCase() + &quot;.sql&quot;);</span>
<span class="nc" id="L123">    export.setFormat(true);</span>
<span class="nc" id="L124">    export.execute(true, false, false, false);</span>
<span class="nc" id="L125">  }</span>

  /**
   * Holds the classnames of hibernate dialects for easy reference.
   */
<span class="nc" id="L130">  private static enum Dialect {</span>

<span class="nc" id="L132">    POSTGRESQL(&quot;org.hibernate.dialect.PostgreSQLDialect&quot;),</span>
<span class="nc" id="L133">    ORACLE(&quot;org.hibernate.dialect.Oracle10gDialect&quot;),</span>
<span class="nc" id="L134">    MYSQL(&quot;org.hibernate.dialect.MySQLDialect&quot;),</span>
<span class="nc" id="L135">    HSQL(&quot;org.hibernate.dialect.HSQLDialect&quot;),</span>
<span class="nc" id="L136">    H2(&quot;org.hibernate.dialect.H2Dialect&quot;);</span>

    private final String dialectClass;

<span class="nc" id="L140">    private Dialect(String dialectClass) {</span>
<span class="nc" id="L141">      this.dialectClass = dialectClass;</span>
<span class="nc" id="L142">    }</span>

    public String getDialectClass() {
<span class="nc" id="L145">      return dialectClass;</span>
    }
  }

  private List&lt;Class&gt; findAnnotatedClassesInPackage(String basePackage, Class annotationClass) throws IOException, ClassNotFoundException {
<span class="nc" id="L150">    ResourcePatternResolver resourcePatternResolver = new PathMatchingResourcePatternResolver();</span>
<span class="nc" id="L151">    MetadataReaderFactory metadataReaderFactory = new CachingMetadataReaderFactory(resourcePatternResolver);</span>

<span class="nc" id="L153">    List&lt;Class&gt; candidates = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L154">    String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX</span>
<span class="nc" id="L155">            + resolveBasePackage(basePackage) + &quot;/&quot; + &quot;**/*.class&quot;;</span>
<span class="nc" id="L156">    Resource[] resources = resourcePatternResolver.getResources(packageSearchPath);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">    for (Resource resource : resources) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">      if (resource.isReadable()) {</span>
<span class="nc" id="L159">        MetadataReader metadataReader = metadataReaderFactory.getMetadataReader(resource);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (isCandidate(metadataReader, annotationClass)) {</span>
<span class="nc" id="L161">          candidates.add(Class.forName(metadataReader.getClassMetadata().getClassName()));</span>
        }
      }
    }
<span class="nc" id="L165">    return candidates;</span>
  }

  private String resolveBasePackage(String basePackage) {
<span class="nc" id="L169">    return ClassUtils.convertClassNameToResourcePath(SystemPropertyUtils.resolvePlaceholders(basePackage));</span>
  }

  private boolean isCandidate(MetadataReader metadataReader, Class annotationClass) throws ClassNotFoundException {
    try {
<span class="nc" id="L174">      Class c = Class.forName(metadataReader.getClassMetadata().getClassName());</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">      if (c.getAnnotation(annotationClass) != null) {</span>
<span class="nc" id="L176">        return true;</span>
      }
<span class="nc" id="L178">    } catch (Throwable e) {</span>
<span class="nc" id="L179">    }</span>
<span class="nc" id="L180">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>
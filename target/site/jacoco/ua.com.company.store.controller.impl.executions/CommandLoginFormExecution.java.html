<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CommandLoginFormExecution.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Store</a> &gt; <a href="index.source.html" class="el_package">ua.com.company.store.controller.impl.executions</a> &gt; <span class="el_source">CommandLoginFormExecution.java</span></div><h1>CommandLoginFormExecution.java</h1><pre class="source lang-java linenums">package ua.com.company.store.controller.impl.executions;

import org.apache.log4j.Logger;
import ua.com.company.store.constants.Redirection;
import ua.com.company.store.controller.command.CommandTypical;
import ua.com.company.store.utils.CookiesAction;
import ua.com.company.store.utils.RedirectionManager;
import ua.com.company.store.utils.ServletWrapper;
import ua.com.company.store.utils.SessionManager;
import ua.com.company.store.hashing.PasswordHashing;
import ua.com.company.store.model.dto.LoginDto;
import ua.com.company.store.model.entity.User;
import ua.com.company.store.service.UserService;
import ua.com.company.store.validation.ValidatorAbstract;
import ua.com.company.store.validation.login.LoginUpValidator;
import ua.com.company.store.validation.login.PasswordUpValidator;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.security.NoSuchAlgorithmException;
import java.util.List;
import java.util.Objects;

/**
 * Created by Владислав on 22.11.2017.
 */
public class CommandLoginFormExecution implements CommandTypical {
<span class="nc" id="L31">    private Logger logger = Logger.getRootLogger();</span>
    private UserService userService;
    private PasswordHashing passwordHashing;

<span class="nc" id="L35">    public CommandLoginFormExecution(UserService userService, PasswordHashing passwordHashing) {</span>
<span class="nc" id="L36">        this.userService = userService;</span>
<span class="nc" id="L37">        this.passwordHashing = passwordHashing;</span>
<span class="nc" id="L38">    }</span>

    @Override
    public String execute(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<span class="nc" id="L42">        String login = req.getParameter(&quot;login&quot;);</span>
<span class="nc" id="L43">        String password = req.getParameter(&quot;password&quot;);</span>
<span class="nc" id="L44">        String checkedIds = req.getParameter(&quot;checkMeOut&quot;);</span>

<span class="nc" id="L46">        HttpSession session = req.getSession(true);</span>
        User user;
<span class="nc" id="L48">        LoginDto loginDto = getLoginInputs(login, password);</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (doValidationInputs(loginDto)) {</span>
<span class="nc" id="L50">            logger.info(&quot;Successful validation inputs&quot;);</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">            if (CookiesAction.getUserFromCookie(req, userService).size() == 0) {</span>
<span class="nc" id="L52">                logger.info(&quot;User don't exist in cookie(successful)&quot;);</span>
<span class="nc" id="L53">                user = userService.getUserByNickName(loginDto.getLogin());</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">                if (user == null) {</span>
<span class="nc" id="L55">                    return Redirection.NO_EXIST_USER_PAGE;</span>
                }


<span class="nc" id="L59">                logger.info(&quot;Successful validated --&quot; + user.getNickname());</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">                if (SessionManager.getSessionManager().isUserLoggedIn(session)) {</span>
<span class="nc" id="L61">                    logger.info(&quot;redirection because user in session is already exist &quot;);</span>
<span class="nc" id="L62">                    RedirectionManager.getRediractionManger().redirect(new ServletWrapper(req, resp), &quot;/main.jsp&quot;);</span>
<span class="nc" id="L63">                    return RedirectionManager.REDIRECTION;</span>
                }
<span class="nc bnc" id="L65" title="All 2 branches missed.">                if (validationOnUser(loginDto)) {</span>
<span class="nc" id="L66">                    logger.info(&quot;Successful validation on registered before user&quot;);</span>
<span class="nc" id="L67">                    session.setAttribute(&quot;user&quot;, user);</span>
<span class="nc" id="L68">                    req.setAttribute(&quot;user&quot;, user);</span>

<span class="nc bnc" id="L70" title="All 4 branches missed.">                    if (checkedIds != null &amp;&amp; checkedIds.equals(&quot;OK&quot;)) {</span>
<span class="nc" id="L71">                        CookiesAction.setCookieUserInform(resp, user);</span>
<span class="nc" id="L72">                        logger.info(&quot;Marked checkbox and added user in cookie successfully&quot;);</span>
                    }else {
<span class="nc" id="L74">                        logger.info(&quot;Continue execution without adding in cookie &quot;);</span>
                    }
<span class="nc" id="L76">                    return Redirection.MAIN_PAGE;</span>
                } else {
<span class="nc" id="L78">                    return Redirection.NO_EXIST_USER_PAGE;</span>
                }

            } else {
<span class="nc" id="L82">                logger.info(&quot;User exist in cookie so do redirect to main page&quot;);</span>
<span class="nc" id="L83">                List list = CookiesAction.getUserFromCookie(req, userService);</span>
<span class="nc" id="L84">                User user1 = (User) list.get(0);</span>
<span class="nc" id="L85">                session.setAttribute(&quot;user&quot;, user1);</span>
<span class="nc" id="L86">                req.setAttribute(&quot;user&quot;, user1);</span>
<span class="nc" id="L87">                return Redirection.MAIN_PAGE;</span>

            }
        }else {
<span class="nc" id="L91">            logger.info(&quot;Validated inputs failed &quot; + loginDto.getLogin() + &quot; -- &quot; + loginDto.getPassword());</span>
<span class="nc" id="L92">            req.setAttribute(&quot;error&quot;, &quot; NUll inputs!!!&quot;);</span>
<span class="nc" id="L93">            return Redirection.ERRORS_WITH_INPUTS;</span>

        }
    }


    /**
     * @param loginDto
     * @return true when input correct
     * else false
     * Method using change of responsibility pattern for validating inputs
     */
    private boolean doValidationInputs(LoginDto loginDto) {
<span class="nc" id="L106">        ValidatorAbstract validatorAbstractLogin = new LoginUpValidator();</span>
<span class="nc" id="L107">        ValidatorAbstract validatorAbstractPassword = new PasswordUpValidator();</span>
<span class="nc" id="L108">        validatorAbstractLogin.setNextValidator(validatorAbstractPassword);</span>
<span class="nc" id="L109">        return validatorAbstractLogin.validate(loginDto.getLogin(), loginDto.getPassword());</span>
    }

    private LoginDto getLoginInputs(String login, String password) {
<span class="nc" id="L113">        return new LoginDto(login, password);</span>
    }

    /**
     * @param loginDto
     * @return true if new user is exist before
     *
     */
    private boolean validationOnUser(LoginDto loginDto) {
<span class="nc bnc" id="L122" title="All 2 branches missed.">        for (User user: userService.getAllUsers()){</span>
            try {
<span class="nc bnc" id="L124" title="All 2 branches missed.">                if (Objects.equals(user.getNickname(), loginDto.getLogin())</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                        &amp;&amp; user.getPassword().equals(passwordHashing.hashingPassword(loginDto.getPassword()))){</span>
<span class="nc" id="L126">                    return true;</span>
                }
<span class="nc" id="L128">            } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L129">                e.printStackTrace();</span>
<span class="nc" id="L130">            }</span>
<span class="nc" id="L131">        }</span>
<span class="nc" id="L132">        return false;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>
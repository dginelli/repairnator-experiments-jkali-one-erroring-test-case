<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractDao.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Store</a> &gt; <a href="index.source.html" class="el_package">ua.com.company.store.model.dao.daoAbstract</a> &gt; <span class="el_source">AbstractDao.java</span></div><h1>AbstractDao.java</h1><pre class="source lang-java linenums">package ua.com.company.store.model.dao.daoAbstract;

import org.apache.log4j.Logger;
import ua.com.company.store.model.dao.connection.ConnectionPoolDataSource;
import ua.com.company.store.model.dao.connection.JDBCConnectionPool;
import ua.com.company.store.model.entity.Image;
import ua.com.company.store.model.entity.Product;
import ua.com.company.store.model.entity.User;

import java.sql.*;
import java.util.List;

/**
 * Created by Владислав on 22.1 1.2017.
 */
public abstract class AbstractDao&lt;T&gt; implements GenericDAO&lt;T&gt; {
<span class="nc" id="L17">    private Logger logger = Logger.getRootLogger();</span>
    private ConnectionPoolDataSource connectionPoolDataSource;
    private JDBCConnectionPool jdbcConnectionPool;


<span class="nc" id="L22">    public AbstractDao(JDBCConnectionPool jdbcConnectionPool) {</span>
<span class="nc" id="L23">        this.jdbcConnectionPool = jdbcConnectionPool;</span>
<span class="nc" id="L24">        }</span>

    /**
     * @return returns sql statement as string for getting all elements 'SELECT * FROM [TABLE]'
     */
    public abstract String getSelectQuery();

    /**
     * @return returns sql statement as string for insert new note 'insert into [table] (column ...) values (?...)'
     */
    public abstract String getCreateQuery();

    /**
     * @return returns sql statement as string for updating elements 'update [table] set [column = ? ..,.] where id =?'
     */
    public abstract String getUpdateQuery();

    /**
     * @return returns sql statement as string for deleting rows'SELECT * FROM [TABLE]'
     */
    public abstract String getDeleteQuery();


    /**
     * @return returns sql statement as string for insert rows
     */
    public abstract String getInsertQuery();

    protected abstract List&lt;T&gt; parseResultSet(ResultSet rs);

    protected abstract void prepareStatemantForInsert(PreparedStatement statement, T object);


    protected abstract void prepareStatemantForDelete(PreparedStatement statement, T object);

    @Override
    public int insert(T object) {
<span class="nc" id="L61">        int id = 0;</span>
<span class="nc" id="L62">        String query = getInsertQuery();</span>
<span class="nc" id="L63">        Connection connection = null;</span>
<span class="nc" id="L64">        PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L65">        ResultSet generatedKeys = null;</span>
        try {
<span class="nc" id="L67">            connection = getConnectionFromPool();</span>
<span class="nc" id="L68">            preparedStatement = connection.prepareStatement(query, Statement.RETURN_GENERATED_KEYS);</span>
<span class="nc" id="L69">            prepareStatemantForInsert(preparedStatement, object);</span>
<span class="nc" id="L70">            preparedStatement.executeUpdate();</span>
<span class="nc" id="L71">            System.out.println(id);</span>
<span class="nc" id="L72">            logger.info(&quot;Insert into db new object &quot; + object.toString());</span>
<span class="nc" id="L73">             generatedKeys = preparedStatement.getGeneratedKeys();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">                if (generatedKeys.next()) {</span>
<span class="nc" id="L75">                    id = generatedKeys.getInt(1);</span>
                } else {
<span class="nc" id="L77">                    throw new SQLException(&quot;Creating user failed, no ID obtained.&quot;);</span>
                }
<span class="nc" id="L79">        } catch (SQLException e1) {</span>
<span class="nc" id="L80">            e1.printStackTrace();</span>
        }
        finally {
<span class="nc" id="L83">            closeResources(generatedKeys,preparedStatement,connection);</span>
<span class="nc" id="L84">        }</span>
<span class="nc" id="L85">        return id;</span>
    }

  public void markUserAsDefaulter(User user){

<span class="nc" id="L90">  }</span>
    @Override
    public T getById(int key) {
<span class="nc" id="L93">        List&lt;T&gt; list = null;</span>
<span class="nc" id="L94">        String sql_query = getSelectQuery();</span>
<span class="nc" id="L95">        sql_query += &quot; where id = ? &quot;;</span>
<span class="nc" id="L96">        Connection connection = null;</span>
<span class="nc" id="L97">        PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L98">        ResultSet resultSet = null;</span>
        try {
<span class="nc" id="L100">            connection = getConnectionFromPool();</span>
<span class="nc" id="L101">            preparedStatement = connection.prepareStatement(sql_query);</span>
<span class="nc" id="L102">            preparedStatement.setInt(1, key);</span>
<span class="nc" id="L103">            resultSet = preparedStatement.executeQuery();</span>
<span class="nc" id="L104">            list = parseResultSet(resultSet);</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (list == null) return null;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (list.size() &gt; 1) return null;</span>
<span class="nc" id="L108">        } catch (SQLException e) {</span>
<span class="nc" id="L109">            e.printStackTrace();</span>
<span class="nc" id="L110">            logger.error(&quot;Cant search admin by Id &quot; + key);</span>
        }
        finally {
<span class="nc" id="L113">            closeResources(resultSet,preparedStatement,connection);</span>
<span class="nc" id="L114">        }</span>
<span class="nc" id="L115">        return list.iterator().next();</span>
    }

    public List&lt;T&gt; getAll() {
<span class="nc" id="L119">        List&lt;T&gt; list = null;</span>
<span class="nc" id="L120">        String sql = getSelectQuery();</span>
<span class="nc" id="L121">        Connection connection= null;</span>
<span class="nc" id="L122">        PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L123">        ResultSet resultSet = null;</span>
        try {
<span class="nc" id="L125">            connection = getConnectionFromPool();</span>
<span class="nc" id="L126">            preparedStatement = connection.prepareStatement(sql);</span>
<span class="nc" id="L127">            resultSet = preparedStatement.executeQuery();</span>
<span class="nc" id="L128">            list = parseResultSet(resultSet);</span>

<span class="nc" id="L130">        } catch (SQLException e) {</span>
<span class="nc" id="L131">            e.printStackTrace();</span>
<span class="nc" id="L132">            logger.error(&quot;Cant get all admins &quot; + e);</span>
        }
        finally {
<span class="nc" id="L135">            closeResources(resultSet,preparedStatement,connection);</span>
<span class="nc" id="L136">        }</span>
<span class="nc" id="L137">        return list;</span>
    }
    public abstract T getByParameter(String parameter);

    /**
     * Method which persist object
     *
     * @param object
     * @return
     */
    public void delete(T object) {
<span class="nc" id="L148">        Connection connection = null;</span>
        try {
<span class="nc" id="L150">            connection = getConnectionFromPool();</span>
<span class="nc" id="L151">            String sql = getDeleteQuery();</span>
<span class="nc" id="L152">            try (PreparedStatement statement = connection.prepareStatement(sql)) {</span>
<span class="nc" id="L153">                prepareStatemantForDelete(statement,object);</span>
<span class="nc" id="L154">                statement.executeUpdate();</span>
<span class="nc bnc" id="L155" title="All 8 branches missed.">            } catch (SQLException e) {</span>
<span class="nc" id="L156">                e.printStackTrace();</span>
<span class="nc" id="L157">            }</span>

<span class="nc" id="L159">        } catch (SQLException e) {</span>
<span class="nc" id="L160">            e.printStackTrace();</span>
        } finally {
<span class="nc" id="L162">            try {</span>
<span class="nc" id="L163">                connection.close();</span>
<span class="nc" id="L164">            } catch (SQLException e) {</span>
<span class="nc" id="L165">                e.printStackTrace();</span>
<span class="nc" id="L166">            }</span>
<span class="nc" id="L167">        }</span>
<span class="nc" id="L168">    }</span>

    public Connection getConnectionFromPool() throws SQLException{
<span class="nc" id="L171">        return jdbcConnectionPool.getConnection();</span>

       }

    protected void closeResources(ResultSet resultSet, PreparedStatement preparedStatement, Connection connection){
        try {
<span class="nc bnc" id="L177" title="All 2 branches missed.">            if(resultSet != null){</span>
<span class="nc" id="L178">                resultSet.close();</span>

            }
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (preparedStatement != null) {</span>
<span class="nc" id="L182">                preparedStatement.close();</span>
   }
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (connection !=null) {</span>
<span class="nc" id="L185">                connection.close();</span>
   }
<span class="nc" id="L187">        } catch (SQLException e) {</span>
<span class="nc" id="L188">            e.printStackTrace();</span>
<span class="nc" id="L189">        }</span>
<span class="nc" id="L190">    }</span>

    protected void closeResources(PreparedStatement preparedStatement, Connection connection){
        try {
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (preparedStatement !=null) {</span>
<span class="nc" id="L195">                preparedStatement.close();</span>
            }
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (connection != null) {</span>
<span class="nc" id="L198">                connection.close();</span>
  }
<span class="nc" id="L200">        } catch (SQLException e) {</span>
<span class="nc" id="L201">            e.printStackTrace();</span>
<span class="nc" id="L202">        }</span>

<span class="nc" id="L204">    }</span>
    public int[] insertImageAndProduct(Image image, Product product){
<span class="nc" id="L206">        return null;</span>
    };
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>